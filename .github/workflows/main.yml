  name: Build and Deploy to EC2

  on:
    push:
      branches:
        - main

  env:
    NODE_VERSION: 18

  permissions:
    contents: read

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Use Node.js
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Build (ts -> js)
          run: npm run build

        - name: Prepare deploy folder
          run: |
            rm -rf deploy || true
            mkdir deploy
            cp -r dist package*.json deploy/
            cp -r src/data deploy/ || true
            ls -la deploy

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: deploy-package
            path: deploy

    deploy:
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: deploy-package
            path: deploy

        - name: Install SSH + rsync
          run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

        - name: Configure SSH
          run: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

            # Add EC2 host to known_hosts (fixed with host parameter)
            ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

        - name: Upload files to EC2
          env:
            RSYNC_RSH: "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p 22"
          run: |
            rsync -avz --delete deploy/ \
              ubuntu@${{ secrets.EC2_HOST }}:${{ secrets.DEPLOY_DIR }}/

        - name: Restart app on EC2
          run: |
            # Build destination (this will expand to e.g. ubuntu@ec2-xx-xx-xx-xx.compute.amazonaws.com)
            DEST="${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
            echo "Connecting to remote server at ${DEST}..."
            # Run remote commands
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p ${{ secrets.EC2_PORT }} "${DEST}" << 'EOF_REMOTE'
              # ---------- On remote server ----------
              # Use absolute paths for node/npm/pm2 to avoid NVM non-interactive issues.
              NODE_BIN="/home/ubuntu/.nvm/versions/node/v20.17.0/bin"
              export PATH="$NODE_BIN:$PATH"

              echo "Remote Node: $(which node || echo 'node not found')"
              echo "Remote NPM:  $(which npm || echo 'npm not found')"
              echo "Remote PM2:  $(which pm2 || echo 'pm2 not found')"

              # change to deploy dir
              cd "${{ secrets.DEPLOY_DIR }}" || { echo "deploy dir missing"; exit 2; }

              echo "Installing production dependencies..."
              /home/ubuntu/.nvm/versions/node/v20.17.0/bin/npm ci --only=production

              echo "Stopping existing PM2 app (if any)..."
              if /home/ubuntu/.nvm/versions/node/v20.17.0/bin/pm2 id fleet-tracking > /dev/null 2>&1; then
                /home/ubuntu/.nvm/versions/node/v20.17.0/bin/pm2 stop fleet-tracking || true
                /home/ubuntu/.nvm/versions/node/v20.17.0/bin/pm2 delete fleet-tracking || true
              fi

              echo "Starting app with PM2..."
              /home/ubuntu/.nvm/versions/node/v20.17.0/bin/pm2 start dist/main.js --name fleet-tracking --time
              /home/ubuntu/.nvm/versions/node/v20.17.0/bin/pm2 save

              echo "Remote deploy finished."
              exit 0
            EOF_REMOTE
          shell: bash

