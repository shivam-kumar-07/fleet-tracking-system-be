  name: Build and Deploy to EC2

  on:
    push:
      branches:
        - main

  env:
    NODE_VERSION: 18

  permissions:
    contents: read

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Use Node.js
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Build (ts -> js)
          run: npm run build

        - name: Prepare deploy folder
          run: |
            rm -rf deploy || true
            mkdir deploy

            # Copy data into dist/ (this is the fix)
            cp -r src/data dist/data || true

            # Copy final build output into deploy folder
            cp -r dist package*.json deploy/
            ls -la deploy


        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: deploy-package
            path: deploy

    deploy:
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: deploy-package
            path: deploy

        - name: Install SSH + rsync
          run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

        - name: Configure SSH
          run: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

            # Add EC2 host to known_hosts (fixed with host parameter)
            ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

        - name: Upload files to EC2
          env:
            RSYNC_RSH: "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p 22"
          run: |
            rsync -avz --delete deploy/ \
              ubuntu@${{ secrets.EC2_HOST }}:${{ secrets.DEPLOY_DIR }}/

        - name: Restart app on EC2
          run: |
            echo "Connecting to remote server..."

            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p 22 ubuntu@${{ secrets.EC2_HOST }} << EOF_REMOTE
              
              cd "${{ secrets.DEPLOY_DIR }}"

              echo "Installing production dependencies..."
              npm ci --only=production

              echo "Stopping existing app safely..."
              pm2 stop fleet-tracking 2>/dev/null || true
              pm2 delete fleet-tracking 2>/dev/null || true

              echo "Starting app with PM2..."
              pm2 start dist/main.js --name fleet-tracking --time

              echo "Saving PM2 state..."
              pm2 save

              echo "PM2 status:"
              pm2 list

              echo "Remote deploy finished."
              exit 0
            EOF_REMOTE


